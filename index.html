<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>善三の手紙｜日めくり</title>
<link href="https://fonts.googleapis.com/css2?family=Sawarabi+Mincho&display=swap" rel="stylesheet">
<style>
  :root{--color-ink:#111;--color-overlay:rgba(255,255,255,.28);--radius:18px;--pad:22px;--paper-url:url('paper.jpg');--maxw:780px}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:#e7e6e2;color:var(--color-ink);font:16px/1.9 'Sawarabi Mincho',serif;display:flex;align-items:center;justify-content:center;padding:16px}
  .sheet{position:relative;width:100%;max-width:var(--maxw);min-height:70vh;border-radius:var(--radius);box-shadow:0 18px 40px rgba(0,0,0,.18);overflow:hidden;background:#fff}
  .sheet::before{content:"";position:absolute;inset:0;background-image:var(--paper-url);background-size:cover;background-position:center;filter:contrast(1.02) saturate(1.02) brightness(1.02)}
  .sheet::after{content:"";position:absolute;inset:0;background:var(--color-overlay)}
  #dateLabel{position:absolute;top:10px;right:14px;font-size:14px;color:#6b7280;opacity:.9}
  .content{position:relative;display:flex;align-items:center;justify-content:center;min-height:70vh;padding:clamp(16px,3.2vw,var(--pad));text-align:center}
  .letter{white-space:pre-wrap;font-size:clamp(18px,2.5vw,22px);line-height:2.0;color:var(--color-ink);
    text-shadow:0 1px 0 rgba(255,255,255,.75),0 0 1px rgba(0,0,0,.08);max-width:42ch;margin:0 auto}
</style>
</head>
<body>
  <main class="sheet" role="article" aria-label="善三の手紙">
    <div id="dateLabel">—</div>
    <div class="content"><section id="letter" class="letter">読み込み中…</section></div>
  </main>

<script>
function getJstDate(d=new Date()){const s=d.toLocaleString('en-US',{timeZone:'Asia/Tokyo'});return new Date(s)}
function ymd(dt){const y=dt.getFullYear(),m=String(dt.getMonth()+1).padStart(2,'0'),d=String(dt.getDate()).padStart(2,'0');return `${y}-${m}-${d}`}
function dayOfYear(dt){const s=new Date(dt.getFullYear(),0,1);return Math.floor((dt-s)/86400000)+1}

/* JSON→[{text}]、TXT→1行ずつ[{text}] に正規化 */
async function loadLetters(){
  // 1) JSON優先
  try{
    const r=await fetch('letters.json?v='+Date.now(),{cache:'no-store'});
    if(r.ok){ const j=await r.json(); if(Array.isArray(j.letters)) return j.letters; }
  }catch(_){}
  // 2) テキストの候補を順に探す
  const candidates=['letters.txt','zenzo_calendar_365.txt','zenzo_calendar.txt'];
  for(const path of candidates){
    try{
      const r=await fetch(`${path}?v=${Date.now()}`,{cache:'no-store'});
      if(r.ok){
        const t=await r.text();
        const arr=t.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).map(text=>({text}));
        if(arr.length) return arr;
      }
    }catch(_){}
  }
  // 3) 何もなければサンプル1件
  return [{text:'（データがありません。letters.json か letters.txt を置いてください）'}];
}

(async function init(){
  const now=getJstDate();
  document.getElementById('dateLabel').textContent=ymd(now);
  const letters=await loadLetters();

  // date 指定（JSONのみ）を最優先
  const byDate=new Map();
  for(const it of letters){ if(it.date) byDate.set(it.date,it); }
  let chosen=byDate.get(ymd(now));
  if(!chosen){
    const pool=letters.filter(it=>!it.date);
    const idx=(dayOfYear(now)-1)%pool.length;
    chosen=pool[idx];
  }
  document.getElementById('letter').textContent=chosen?.text||'';
})();
</script>
</body>
</html>
